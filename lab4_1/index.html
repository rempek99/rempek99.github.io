<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-Ua-Compatible" content="IE=edge,chrome=1">
    <link rel="stylesheet" href="style.css">
    <title>lab4</title>
</head>

<body>
    <div class="root">
        Arkadiusz Remplewicz 249106
        <h1>Lab4</h1>
        <form>
            <label for="email">E-mail:</label>
            <input id="email" type="email" placeholder="example@mail.com" required><br>
            <label for="postal">Postal code:</label>
            <input id="postal" placeholder="00-000" required pattern="^\d{2}-\d{3}$"><br>
            <label for="nip">NIP:</label>
            <input id="nip" placeholder="1234567890" required pattern="\d{10}"><br>
            <label for="idendity">ID number:</label>
            <input id="identity" placeholder="ABC123456" required pattern="^\w{3}\d{6}$"><br>
            <label for="www">WWW:</label>
            <input id="www" placeholder="http://example.com" onblur="checkURL(this)" type="url" required><br>
            <label for="telephone">Phone Number:</label>
            <input id="telephone" placeholder="123456789" type="tel" required><br>
            <p>-------</p>
            <label for="birth-date">Birth date:</label>
            <input type="date" id="birth-date" name="birth-date" required><br>
        </form>
        <button onclick="addItem()">Add client</button><br>
        <button onclick="randomData()">Random</button>
        <button onclick="getItems()">get</button><br>
        <h3>CLIENTS:</h3>

        <ul id="clients">
        </ul>
    </div>
    </div>
</body>

<script>
    // (for debugging) check if browser support indexed db 
    if (!('indexedDB' in window)) {
        console.log("This browser doesn't support IndexedDB");
    }

    let db;

    const openRequest = indexedDB.open('myDatabase', 2);

    openRequest.onupgradeneeded = function (e) {
        db = e.target.result;
        console.log('running onupgradeneeded');
        const storeOS = db.createObjectStore('myDatabaseStore', { keyPath: "email" });

    };
    openRequest.onsuccess = function (e) {
        console.log('running onsuccess');
        db = e.target.result;
        getItems();
    };
    openRequest.onerror = function (e) {
        console.log('onerror! doesnt work');
        console.dir(e);
    };


    function addItem() {
        let email = document.getElementById('email').value;
        let name = document.getElementById('name').value;
        let surname = document.getElementById('surname').value;
        const item = {
            email: email,
            name: name,
            surname: surname
        };
        const tx = db.transaction("myDatabaseStore", "readwrite");
        const store = tx.objectStore('myDatabaseStore');
        store.add(item);
        getItems();
    };

    function getItems() {
        const tx = db.transaction("myDatabaseStore", "readwrite");
        const store = tx.objectStore('myDatabaseStore');
        request = store.openCursor();
        const items = [];

        request.onerror = function (event) {
            console.err("error fetching data");
        };



        request.onsuccess = function (event) {
            let cursor = event.target.result;
            if (cursor) {
                let key = cursor.primaryKey;
                let value = cursor.value;
                items.push(value)
                cursor.continue();
            }
            updateList(items);
        }
    };

    function updateList(newItems) {
        var list = document.getElementById('clients');
        list.replaceChildren([]);
        for (var i = 0; i < newItems.length; i++) {
            var element = document.createElement('li');
            var elContent = document.createElement('div');
            var delBut = document.createElement('button');
            const key = newItems[i].email;
            delBut.addEventListener("click", () => { deleteItem(key); });
            delBut.innerHTML = 'delete';
            elContent.innerHTML = newItems[i].email + ', ' + newItems[i].name + ', ' + newItems[i].surname + '  ';
            elContent.appendChild(delBut)
            element.appendChild(elContent);
            list.appendChild(element);

        }
    }

    function deleteItem(key) {
        const tx = db.transaction("myDatabaseStore", "readwrite");
        const store = tx.objectStore('myDatabaseStore');
        store.delete(key);
        getItems();
    }

    var counter = 0;

    function randomData() {
        const random_data = [
            [
                { key: '#email', value: '224413@edu.p.lodz.pl' },
                { key: '#postal', value: '12-213' },
                { key: '#nip', value: '0987654321' },
                { key: '#identity', value: 'XXX123123' },
                { key: '#www', value: 'http://www.google.com' },
                { key: '#telephone', value: '123123123' },
                { key: '#birth-date', value: '1999-02-11' }],
            [
                { key: '#email', value: 'jacex@wp.pl' },
                { key: '#postal', value: '09-213' },
                { key: '#nip', value: '1237123321' },
                { key: '#identity', value: 'QWE123193' },
                { key: '#www', value: 'http://www.yahoo.com' },
                { key: '#telephone', value: '999123123' },
                { key: '#birth-date', value: '1972-11-11' }],
            [
                { key: '#email', value: 'iwona@o2.eu' },
                { key: '#postal', value: '91-413' },
                { key: '#nip', value: '5557123999' },
                { key: '#identity', value: 'QWE666693' },
                { key: '#www', value: 'http://www.xdddddd.com' },
                { key: '#telephone', value: '001123000' },
                { key: '#birth-date', value: '1995-01-20' }],

        ]
        console.log(counter)
        for (i = 0; i < random_data[counter].length; i++) {
            element = random_data[counter][i];
            document.querySelector(element.key).value = element.value;
        }
        counter++;
        if (counter >= random_data.length) {
            counter = 0;
        }
        // random_data[0].array.forEach(element => {
        //     document.querySelector(element.key).value = element.value;
        // });

        // document.querySelector('#email').value = "224413@edu.p.lodz.pl"
        // document.querySelector('#postal').value = "11-213"
        // document.querySelector('#nip').value = "0987654321"
        // document.querySelector('#identity').value = "XXX321333"
        // document.querySelector('#www').value = "http://www.google.com"
        // document.querySelector('#telephone').value= "421512532";
        // document.querySelector('#birth-date').value= "1999-02-11";
    }

</script>

</html>
<!-- Proszę przygotować aplikację wykorzystującą IndexedDB do zarządzania
bazą klientów/kontrahentów. -->